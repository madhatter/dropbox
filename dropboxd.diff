1,3c1
< #!/bin/sh
< 
< # Copyright 2008 Evenflow, Inc., 2010 Dropbox
---
> #copyright 2008 Evenflow, Inc., 2010 Dropbox
6a5
> start_dropbox() {
9,10c8,41
< LD_LIBRARY_PATH=$PAR${LD_LIBRARY_PATH:+:}$LD_LIBRARY_PATH
< exec $PAR/dropbox $@
---
> LD_LIBRARY_PATH=$PAR:$LD_LIBRARY_PATH
> 
> TMP1=`ps ax|grep dropbox|grep -v grep`
> if [ -n "$TMP1" ]; then
>   kill -9 $(pidof dropbox) >/dev/null 2>&1
> fi
> exec $PAR/dropbox $@ &
> }
> 
> do_dropbox() {
> start_dropbox >/dev/null 2>&1
> while [ 1 ]; do
>   sleep 5
>   ERROR="$(net_test)"
>   if [ -n "$ERROR" ]; then
>     LAST_ERROR=1
>   else
>     if [ -n "$LAST_ERROR" ]; then
>       # Connection seems to be up but last cycle was down
>       LAST_ERROR=""
>       start_dropbox >/dev/null 2>&1
>     fi
>   fi
> done
> 
> }
> 
> net_test() {
> TMP1="$(ip addr |grep "inet " |grep -v "127.0.0.1")"
> [ -z "$TMP1" ] && echo "error"
> }
> 
> do_dropbox
> 
